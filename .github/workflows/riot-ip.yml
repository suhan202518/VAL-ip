name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Precheck Secrets
      id: secret_check
      run: |
        # å¼ºåˆ¶éªŒè¯å¯†é’¥å­˜åœ¨æ€§
        if [ -z "${{ secrets.CF_TOKEN }}" ]; then
          echo "::error::âŒ è‡´å‘½é”™è¯¯ï¼šCF_TOKENæœªé…ç½® â†’ è¯·åˆ°ä»“åº“ Settings â†’ Secrets â†’ Actions æ·»åŠ "
          echo "::warning::åˆ›å»ºæŒ‡å¼•ï¼šhttps://dash.cloudflare.com/profile/api-tokens"
          echo "::warning::æ‰€éœ€æƒé™ï¼šZone.Read + Radar.Read"
          exit 1
        fi
        echo "âœ… å¯†é’¥é¢„æ£€é€šè¿‡"

    - name: Fetch IPs
      env:
        CF_TOKEN: ${{ secrets.CF_TOKEN }}
      run: |
        # å¸¦è®¤è¯å¤´çš„è¯·æ±‚
        curl -s -H "Authorization: Bearer $CF_TOKEN" \
          "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" \
          -o riot_cache.json

        # è®¤è¯å¤±è´¥è¯Šæ–­
        if ! jq -e '.success == true' riot_cache.json >/dev/null; then
          echo "::error::âŒ Cloudflare APIå“åº”å¼‚å¸¸"
          echo "::warning::é”™è¯¯è¯¦æƒ…ï¼š$(jq -c '.errors[0].message' riot_cache.json)"
          echo "::warning::è¯·ç¡®è®¤ï¼š1.API Tokenæœ‰æ•ˆ 2.ASNç¼–å·æ­£ç¡®"
          exit 1
        fi

        # ç”Ÿæˆè§„åˆ™æ–‡ä»¶
        echo "payload:" > val-ip.yaml
        {
          echo "  - DOMAIN-SUFFIX,riotgames.com,ðŸŽ®VALORANT"
          echo "  - DOMAIN-SUFFIX,valorantgame.com,ðŸŽ®VALORANT"
          jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),ðŸŽ®VALORANT"' riot_cache.json
        } >> val-ip.yaml

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: valorant-rules
        path: val-ip.yaml

    - name: Deploy Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
