name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

env:
  CF_TOKEN: ${{ secrets.CF_TOKEN }}

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate Configuration
      run: |
        # å®‰å…¨éªŒè¯å¯†é’¥çŠ¶æ€
        echo "é…ç½®è¯Šæ–­æŠ¥å‘Šï¼š"
        echo "----------------------------------"
        echo "Secretåç§°: CF_TOKEN"
        echo "å­—ç¬¦é•¿åº¦: ${#CF_TOKEN}"
        echo "é¦–å­—ç¬¦: ${CF_TOKEN:0:1}***${CF_TOKEN: -1}"
        echo "----------------------------------"
        
        if [ -z "$CF_TOKEN" ]; then
          echo "::error::âŒ å¯†é’¥æœªé…ç½® â†’ è¯·åˆ°ä»“åº“Settingsâ†’Secretsâ†’Actionsåˆ›å»ºCF_TOKEN"
          echo "::warning::ðŸ“ åˆ›å»ºæŒ‡å¼•ï¼šhttps://dash.cloudflare.com/profile/api-tokens"
          exit 1
        fi

    - name: Fetch IPs
      id: fetch_ips
      run: |
        # å¸¦è°ƒè¯•ä¿¡æ¯çš„è¯·æ±‚æ¨¡å—
        DEBUG_FILE="api_debug.log"
        
        for i in {1..3}; do
          echo "ðŸ”„ å°è¯•ç¬¬${i}æ¬¡è¯·æ±‚..."
          HTTP_STATUS=$(
            curl -si -o riot_cache.json -w "%{http_code}" \
              -H "Authorization: Bearer $CF_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" \
              > $DEBUG_FILE
          )
          
          # è§£æžå“åº”å¤´
          CF_RAY=$(grep 'CF-RAY' $DEBUG_FILE | cut -d ' ' -f 2)
          
          if [ $HTTP_STATUS -eq 200 ]; then
            echo "âœ… è¯·æ±‚æˆåŠŸ (CF-RAY: ${CF_RAY})"
            break
          else
            echo "::warning::âš ï¸ è¯·æ±‚å¤±è´¥ (HTTP ${HTTP_STATUS})"
            echo "è°ƒè¯•çº¿ç´¢ï¼š"
            jq -c '{success,errors}' riot_cache.json
            echo "CF-RAYè¿½è¸ªç : ${CF_RAY}"
            sleep 10
          fi
        done

        if [ $HTTP_STATUS -ne 200 ]; then
          echo "::error::âŒ æ‰€æœ‰é‡è¯•å‡å¤±è´¥"
          echo "::warning::å¯èƒ½åŽŸå› ï¼š"
          echo "1. ä»¤ç‰Œæƒé™ä¸è¶³ï¼ˆéœ€è¦Zone.Read + Radar.Readï¼‰"
          echo "2. ASNç¼–å·é”™è¯¯ï¼ˆå½“å‰æŸ¥è¯¢AS6507ï¼‰"
          exit 1
        fi

        # ç”Ÿæˆè§„åˆ™æ–‡ä»¶
        echo "payload:" > val-ip.yaml
        {
          echo "  - DOMAIN-SUFFIX,riotgames.com,ðŸŽ®VALORANT"
          echo "  - DOMAIN-SUFFIX,valorantgame.com,ðŸŽ®VALORANT"
          jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),ðŸŽ®VALORANT"' riot_cache.json
        } >> val-ip.yaml

    - name: Upload Rules
      uses: actions/upload-artifact@v4
      with:
        name: valorant-rules
        path: val-ip.yaml

    - name: Deploy to Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
