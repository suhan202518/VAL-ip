name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Fetch IPs
      id: fetch_ips  # Ê∑ªÂä†Ê≠•È™§IDÁî®‰∫éÂêéÁª≠ÂºïÁî®
      run: |
        # Ê∑ªÂä†APIÁºìÂ≠òÊú∫Âà∂Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
        if [ -f riot_cache.json ]; then
          etag=$(jq -r '.headers.etag[0]' riot_cache.json)
          curl -s -H "If-None-Match: $etag" \
            "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" \
            -o new_data.json
          
          if [ $? -eq 0 ] && [ -s new_data.json ]; then
            mv new_data.json riot_cache.json
            echo "changed=true" >> $GITHUB_OUTPUT  # ËÆæÁΩÆËæìÂá∫ÂèòÈáè
          else
            echo "nochanges" >> riot_cache.json
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
        else
          curl -s -D headers.txt \
            "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" \
            -o riot_cache.json
          echo "changed=true" >> $GITHUB_OUTPUT
        fi

        # ÁîüÊàêËßÑÂàôÊñá‰ª∂Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
        jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),üéÆVALORANT"' riot_cache.json > riot_rules.yaml
        echo -e "payload:\n- DOMAIN-SUFFIX,riotgames.com,üéÆVALORANT\n- DOMAIN-SUFFIX,valorantgame.com,üéÆVALORANT" | cat - riot_rules.yaml > val-ip.yaml

    - name: Conditional Upload
      if: ${{ steps.fetch_ips.outputs.changed == 'true' }}  # Ê≠£Á°ÆËØ≠Ê≥ïÊ†ºÂºè
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true
