name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Validate Secrets
      id: secret_validation
      run: |
        # ç¡¬æ€§å¯†é’¥å­˜åœ¨æ€§æ£€æŸ¥
        if [ -z "${{ secrets.CF_TOKEN }}" ]; then
          echo "::error::âŒ å…³é”®é”™è¯¯ï¼šCF_TOKENæœªé…ç½® â†’ ç«‹å³ä¿®å¤ï¼šhttps://github.com/$GITHUB_REPOSITORY/settings/secrets/actions/new"
          echo "::warning::åç§°å¿…é¡»ä¸¥æ ¼ä½¿ç”¨ã€ŒCF_TOKENã€"
          echo "::warning::æƒé™è¦æ±‚ï¼šZone.Zone.Read + Radar.Radar.Read"
          exit 1
        fi
        
        # ç¯å¢ƒå˜é‡é•¿åº¦éªŒè¯
        TOKEN_LENGTH=${#SECRET_CONTENT}
        if [ $TOKEN_LENGTH -lt 50 ]; then
          echo "::error::âŒ å¯†é’¥æ ¼å¼å¼‚å¸¸ï¼ˆæœ‰æ•ˆTokenåº”è¶…è¿‡50å­—ç¬¦ï¼‰"
          echo "::warning::è¯·ç¡®è®¤å¤åˆ¶äº†å®Œæ•´çš„API Token"
          exit 1
        fi
        echo "âœ… å¯†é’¥åŸºç¡€éªŒè¯é€šè¿‡"
      env:
        SECRET_CONTENT: ${{ secrets.CF_TOKEN }}

    - name: Fetch IP Data
      env:
        CF_API_TOKEN: ${{ secrets.CF_TOKEN }}
      run: |
        # å¸¦å¤±è´¥é‡è¯•çš„è¯·æ±‚
        RESPONSE=$(curl --retry 3 --fail-with-body -s \
          -H "Authorization: Bearer $CF_API_TOKEN" \
          "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json")

        # APIé”™è¯¯è¯Šæ–­
        if ! jq -e '.success == true' <<< "$RESPONSE"; then
          ERROR_MSG=$(jq -r '.errors[0].message' <<< "$RESPONSE")
          echo "::error::âŒ Cloudflare APIé”™è¯¯ï¼š$ERROR_MSG"
          echo "::warning::è¯Šæ–­å»ºè®®ï¼š"
          echo "1. è®¿é—® https://dash.cloudflare.com/profile/api-tokens"
          echo "2. ç¡®è®¤TokenåŒ…å«ä»¥ä¸‹æƒé™ï¼š"
          echo "   - Zone.Zone.Read"
          echo "   - Radar.Radar.Read"
          exit 1
        fi

        # ä¿å­˜æœ‰æ•ˆæ•°æ®
        jq '.' <<< "$RESPONSE" > riot_cache.json

    - name: Generate Rules
      run: |
        # ç”ŸæˆYAMLè§„åˆ™æ–‡ä»¶
        echo "payload:" > val-ip.yaml
        {
          echo "  - DOMAIN-SUFFIX,riotgames.com,ğŸ®VALORANT"
          echo "  - DOMAIN-SUFFIX,valorantgame.com,ğŸ®VALORANT"
          jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),ğŸ®VALORANT"' riot_cache.json
        } >> val-ip.yaml

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-rules
        path: val-ip.yaml

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
