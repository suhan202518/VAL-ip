name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

env:
  CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate Secrets
      run: |
        # å®‰å…¨è°ƒè¯•è¾“å‡ºï¼ˆä¸æ‰“å°å¯†é’¥å†…å®¹ï¼‰
        echo "å¯†é’¥çŠ¶æ€ï¼š"
        echo "CLOUDFLARE_API_TOKEN: ${#CLOUDFLARE_API_TOKEN} å­—ç¬¦"
        if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
          echo "::error::è¯·åœ¨ä»“åº“Settingsâ†’Secretsä¸­é…ç½®CLOUDFLARE_API_TOKEN"
          echo "::warning::éœ€è¦åˆ›å»ºå…·å¤‡Zone.Readå’ŒRadar.Readæƒé™çš„API Token"
          exit 1
        fi

    - name: Fetch IPs
      id: fetch_ips
      run: |
        # å¸¦è®¤è¯å¤±è´¥è¯Šæ–­çš„é‡è¯•æœºåˆ¶
        RETRY_COUNT=0
        MAX_RETRY=3
        while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
          HTTP_CODE=$(curl -s -o riot_cache.json -w "%{http_code}" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json")
          
          if [ $HTTP_CODE -eq 200 ] && jq -e '.success == true and .result.ipv4_prefixes != null and (.result.ipv4_prefixes | length) > 0' riot_cache.json >/dev/null; then
            echo "APIè¯·æ±‚æˆåŠŸ"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "::warning::ç¬¬${RETRY_COUNT}æ¬¡è¯·æ±‚å¤±è´¥ (HTTP ${HTTP_CODE})"
            echo "å“åº”æ‘˜è¦ï¼š$(jq -c '{success,errors}' riot_cache.json)"
            sleep 10
          fi
        done

        if [ $RETRY_COUNT -eq $MAX_RETRY ]; then
          echo "::error::æœ€ç»ˆå¤±è´¥å“åº”ï¼š"
          jq . riot_cache.json
          echo "::warning::è¯·æ£€æŸ¥ï¼š1.API Tokenæƒé™ 2.ASNç¼–å·æ˜¯å¦æ­£ç¡®"
          exit 1
        fi

        # ç”Ÿæˆè§„åˆ™æ–‡ä»¶
        echo "# Auto-generated at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > val-ip.yaml
        echo "payload:" >> val-ip.yaml
        {
          echo "  - DOMAIN-SUFFIX,riotgames.com,ðŸŽ®VALORANT"
          echo "  - DOMAIN-SUFFIX,valorantgame.com,ðŸŽ®VALORANT"
          jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),ðŸŽ®VALORANT"' riot_cache.json
        } >> val-ip.yaml

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: valorant-rules
        path: val-ip.yaml

    - name: Deploy Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
