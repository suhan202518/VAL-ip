name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Validate Secrets
      id: secret_validation
      run: |
        # å¼ºåŒ–å¯†é’¥éªŒè¯é€»è¾‘
        if [ -z "${{ secrets.CF_TOKEN }}" ]; then
          echo "::error::âŒ å…³é”®é”™è¯¯ï¼šCF_TOKENæœªé…ç½® â†’ ç«‹å³ä¿®å¤ï¼šhttps://github.com/$GITHUB_REPOSITORY/settings/secrets/actions/new"
          echo "::warning::åç§°å¿…é¡»ä¸¥æ ¼ä½¿ç”¨ã€ŒCF_TOKENã€"
          echo "::warning::æƒé™è¦æ±‚ï¼šZone.Zone.Read + Radar.Radar.Read"
          exit 1
        fi
        
        # é•¿åº¦éªŒè¯å¢å¼º
        TOKEN_LENGTH=$(echo -n "${{ secrets.CF_TOKEN }}" | wc -c)
        if [ $TOKEN_LENGTH -lt 50 ]; then
          echo "::error::âŒ å¯†é’¥æ ¼å¼å¼‚å¸¸ï¼ˆæœ‰æ•ˆTokenåº”è¶…è¿‡50å­—ç¬¦ï¼‰"
          echo "::warning::å½“å‰Tokené•¿åº¦ï¼š$TOKEN_LENGTH"
          echo "::warning::è¯·é‡æ–°ç”ŸæˆAPI Tokenï¼šhttps://dash.cloudflare.com/profile/api-tokens"
          exit 1
        fi
        echo "âœ… å¯†é’¥åŸºç¡€éªŒè¯é€šè¿‡"

    - name: Fetch IP Data
      env:
        CF_API_TOKEN: ${{ secrets.CF_TOKEN }}
      run: |
        set -eo pipefail  # å¯ç”¨ä¸¥æ ¼é”™è¯¯æ£€æŸ¥
        
        # å¸¦è°ƒè¯•ä¿¡æ¯çš„è¯·æ±‚
        RESPONSE=$(curl -v --retry 3 --fail-with-body -s \
          -H "Authorization: Bearer $CF_API_TOKEN" \
          "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" 2>&1 | tee curl_output.log)
        
        # å¢å¼ºé”™è¯¯å¤„ç†
        HTTP_STATUS=$(grep -oP 'HTTP/\d\.\d \K\d+' curl_output.log | tail -1)
        if [ "$HTTP_STATUS" -ne 200 ]; then
          echo "::error::âŒ APIè¯·æ±‚å¤±è´¥ (HTTP $HTTP_STATUS)"
          echo "::group::è°ƒè¯•ä¿¡æ¯"
          cat curl_output.log
          echo "::endgroup::"
          
          case $HTTP_STATUS in
            403)
              echo "::warning::å¯èƒ½åŸå› ï¼š"
              echo "1. Tokenæƒé™ä¸è¶³ï¼ˆéœ€è¦ Radar.Radar.Readï¼‰"
              echo "2. æœªç»‘å®šä»˜æ¬¾æ–¹å¼ï¼ˆéƒ¨åˆ†é›·è¾¾APIéœ€è¦ä»˜è´¹è´¦å·ï¼‰"
              ;;
            404)
              echo "::warning::å¯èƒ½åŸå› ï¼šASN 6507ä¸å­˜åœ¨æˆ–ä¸å¯è®¿é—®"
              ;;
            *)
              echo "::warning::å»ºè®®æ£€æŸ¥ï¼šhttps://developers.cloudflare.com/api/health/"
              ;;
          esac
          exit 1
        fi

        # éªŒè¯JSONç»“æ„
        if ! jq -e '.result.ipv4_prefixes' <<< "$RESPONSE" > /dev/null; then
          echo "::error::âŒ å“åº”æ•°æ®æ ¼å¼å¼‚å¸¸"
          echo "::warning::åŸå§‹å“åº”ï¼š"
          echo "$RESPONSE"
          exit 1
        fi

        # ä¿å­˜æœ‰æ•ˆæ•°æ®
        jq '.' <<< "$RESPONSE" > riot_cache.json
        echo "âœ… æˆåŠŸè·å– $(jq '.result.ipv4_prefixes | length' riot_cache.json) æ¡IPè®°å½•"

    - name: Generate Rules
      run: |
        # æ·»åŠ æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
        if [ ! -s riot_cache.json ]; then
          echo "::error::âŒ ç¼“å­˜æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        echo "payload:" > val-ip.yaml
        {
          echo "  - DOMAIN-SUFFIX,riotgames.com,ğŸ®VALORANT"
          echo "  - DOMAIN-SUFFIX,valorantgame.com,ğŸ®VALORANT"
          jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),ğŸ®VALORANT"' riot_cache.json
        } >> val-ip.yaml

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: game-rules
        path: val-ip.yaml

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        keep_files: true
