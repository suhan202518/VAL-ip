name: Riot IP Updater
on:
  schedule:
    - cron: "0 12 * * *"  # æ¯å¤©UTC 12:00 (åŒ—äº¬æ—¶é—´20:00) æ›´æ–°
  workflow_dispatch:      # ä¿ç•™æ‰‹åŠ¨è§¦å‘

jobs:
  generate-rule:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Fetch IPs
      run: |
        # æ·»åŠ APIç¼“å­˜æœºåˆ¶
        if [ -f riot_cache.json ]; then
          etag=$(jq -r '.headers.etag[0]' riot_cache.json)
          curl -s -H "If-None-Match: $etag" \
            "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" \
            -o new_data.json
          
          if [ $? -eq 0 ] && [ -s new_data.json ]; then
            mv new_data.json riot_cache.json
          fi
        else
          curl -s -D headers.txt \
            "https://api.cloudflare.com/client/v4/radar/asns/6507/prefixes?format=json" \
            -o riot_cache.json
        fi

        # ç”Ÿæˆè§„åˆ™æ–‡ä»¶
        jq -r '.result.ipv4_prefixes[] | "  - IP-CIDR,\(.prefix),ğŸ®VALORANT"' riot_cache.json > riot_rules.yaml
        echo -e "payload:\n- DOMAIN-SUFFIX,riotgames.com,ğŸ®VALORANT\n- DOMAIN-SUFFIX,valorantgame.com,ğŸ®VALORANT" | cat - riot_rules.yaml > val-ip.yaml

    - name: Conditional Upload
      if: "! grep -q 'no changes' riot_cache.json"  # ä»…åœ¨IPå˜åŒ–æ—¶ä¸Šä¼ 
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true  # é¿å…ä¿ç•™å†å²ç‰ˆæœ¬
